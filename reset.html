<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Set New Password â€“ Cashtraq</title>
  <meta name="robots" content="noindex,follow" />
  <meta name="theme-color" content="#008080" />

  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="stylesheet" href="style.css?v=103" />

  <style>
    .auth-card{
      max-width:540px;
      margin:0 auto;
      background:#f0fdfa;
      padding:2rem;
      border-radius:1rem
    }
    body.dark-mode .auth-card{
      background: rgba(255,255,255,0.06);
    }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <button
      id="darkModeToggle"
      class="btn secondary dark-toggle"
      type="button"
      aria-label="Toggle dark mode"
      title="Toggle dark mode"
      style="position:absolute;top:1rem;right:1rem"
    >ðŸŒ“</button>

    <main class="main">
      <div class="container page-content" style="max-width:720px;">
        <div class="logo-container" style="text-align:center;margin-bottom:1rem">
          <img src="assets/cashtraq_logo.svg" alt="Cashtraq" class="logo-img" width="340" height="100" />
        </div>

        <div class="auth-card">
          <h1>Choose a new password</h1>

          <form id="resetForm" novalidate>
            <label for="newPassword">New password</label>
            <input id="newPassword" name="newPassword" type="password" required autocomplete="new-password" />

            <label for="confirmPassword">Confirm password</label>
            <input id="confirmPassword" name="confirmPassword" type="password" required autocomplete="new-password" />

            <button type="submit" class="btn" style="width:100%;margin-top:1rem">Update password</button>
            <p id="msg" role="status" style="margin-top:1rem"></p>
          </form>

          <p style="margin-top:1rem"><a href="login.html">Back to log in</a></p>
        </div>
      </div>
    </main>
  </div>

  <!-- Shared JS (includes dark mode + Supabase client) -->
  <script type="module" src="app.js?v=103"></script>

  <!-- Reset flow (module, uses the supabase instance created in app.js) -->
  <script type="module">
    // Uses the global `supabase` client created in app.js
    // IMPORTANT: In app.js, ensure supabaseUrl + supabaseAnonKey are filled with real values.

    async function exchangeCodeForSessionIfPresent() {
      try {
        // Handles Supabase email link flows (password reset / magic link, etc.)
        await supabase.auth.exchangeCodeForSession(window.location.href);
      } catch (e) {
        // If there's no code in the URL or it was already exchanged, ignore.
      }
    }

    function setMessage(msgEl, text, color) {
      msgEl.textContent = text;
      msgEl.style.color = color || "";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const form = document.getElementById("resetForm");
      const msg = document.getElementById("msg");
      const p1 = document.getElementById("newPassword");
      const p2 = document.getElementById("confirmPassword");

      if (!form || !msg || !p1 || !p2) return;

      await exchangeCodeForSessionIfPresent();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const pass1 = p1.value;
        const pass2 = p2.value;

        if (!pass1 || pass1.length < 8) {
          setMessage(msg, "Please choose a password of at least 8 characters.", "crimson");
          return;
        }

        if (pass1 !== pass2) {
          setMessage(msg, "Passwords do not match.", "crimson");
          return;
        }

        setMessage(msg, "Updatingâ€¦");

        const { error } = await supabase.auth.updateUser({ password: pass1 });

        if (error) {
          setMessage(msg, error.message || "Could not update password.", "crimson");
          return;
        }

        setMessage(msg, "Password updated. Redirecting to loginâ€¦", "green");
        setTimeout(() => window.location.replace("login.html"), 1000);
      });
    });
  </script>
</body>
</html>
